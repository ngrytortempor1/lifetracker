# LifeTracker 更新履歴

このドキュメントは、プロジェクトの主要な変更と追加機能を時系列でまとめたものです。


## 2025-02-08

### Analytics dashboard overhaul
- Replaced the legacy analytics view model with `AnalyticsGraphViewModel`, adding TTL-backed caching, shared filter state, and a presentation mode toggle for chart vs. text output.
- Rebuilt `AnalyticsGraphScreen` to surface predictability, rolling averages, and quick log tag leaderboards with adaptive layouts, filter chips, and accessibility semantics.
- Introduced dedicated Compose components (`RollingAverageChart`, `QuickLogTagLeaderboard`) to render canvas-driven visuals with tooltip interaction and screen reader copy.
- Added unit, instrumentation, and performance regression coverage (`AnalyticsGraphViewModelTest`, `AnalyticsGraphSemanticsTest`, `AnalyticsRepositoryPerformanceTest`) to validate caching paths and storage parity.
- Updated `docs/specs/analytics_graph_view_todo.md` to close out the analytics graph implementation checklist.

---

## 2025-11-04

### Dashboard export planning
- Added `docs/specs/dashboard_export_todo.md` outlining the CSV/PDF export workflow for dashboard metrics, including data snapshot mapping, formatters, file sharing, and UI integration tasks.
- Captured open questions around localization and data redaction to revisit during implementation.

---

## 2025-11-02

### Storage location selection
- Added `StorageLocationManager` and `JsonlStorageLocation` to persist and resolve the user-selected JSONL directory.
- Prompt the user on first launch via `StorageLocationSelectionScreen` and migrate existing JSON files into the chosen location.
- Updated `JsonlStorage`, DI wiring, and documentation to honour the selected base directory.

### Storage plugin abstraction
- Introduced `StoragePlugin` / `StoragePluginRegistry` to formalise pluggable persistence backends.
- Moved the JSONL implementation under `com.lifetracker.app.plugins.storage.json` and exposed it via `JsonStoragePlugin`.
- Updated `AppContainer` and `LifeTrackerApplication` to resolve storage via the active plugin.

### Wellness data pipeline
- Extended `LifeTrackerStorage` so plugins persist mood entries and sleep sessions alongside existing data.
- Updated `JsonlStorage` / `SqliteStorage` to read-write mood・sleep records and seed SQLite from JSONL where necessary.
- Added `WellnessRepository` (kernel) and `JsonWellnessRepository` (app) to expose reactive mood/sleep flows.
- Surfaced the latest mood score and sleep summary on the dashboard for quick wellness checks.

### Event analytics foundation
- Implemented `JsonEventAnalyticsRepository` and `SqliteEventAnalyticsRepository`, wiring them through `AppContainer` for plugin-aware analytics resolution.
- Added SQL-backed aggregations (`LifeTrackerDao.countEventsByType`, typed event rows) and bumped the Room schema (v4) to store event type + metadata JSON.
- Implemented reusable calculations (rolling averages, quick log leaders, routine predictability dataset) and exposed them via `EventAnalyticsRepository`.

### Event metadata enrichment
- Added `EventMetadata` + `Event.ensureMetadata()` so all events carry tag/detail context for analytics.
- Expanded `EventEntity` with dedicated columns and bumped the Room schema (v3) to persist metadata alongside the raw payload.
- Ensured JSONL append/seeding/outbox sync paths enrich legacy events with derived metadata for forward compatibility.

### Analytics & testing foundation
- Added Mood/Sleep Room entities in the SQLite plugin and documented dual-run operations (`docs/sqlite_jsonl_dual_run.md`).
- Published `EventAnalyticsRepository` to expose aggregated event insights.
- Added `docs/testing_strategy.md` and referenced it from the development guide for consistent testing practices.
- Introduced unit tests for `LifeTrackerDao` and `JsonlStorage`, plus a Compose semantics snapshot (`DashboardAnalyticsSnapshotTest`) covering the dashboard analytics cards.
- Documented the staged JSONL → SQLite migration plan, Gradle build-logic outlook, and logging strategy updates (`docs/sqlite_jsonl_dual_run.md`, `docs/build_logic_outlook.md`, `docs/logging_strategy.md`).

### Testing & tooling hardening
- Added in-memory Room DAO/outbox regression tests using Robolectric to ensure ordering, grouping, and processing semantics.
- Added JSONL storage resilience tests validating corrupt line skipping and metadata seeding behavior.
- Introduced unit-test dependencies (`room-testing`, `kotlinx-coroutines-test`, `robolectric`, `androidx.test:core-ktx`) to support host-side execution.

### Updated files
- `app/src/main/java/com/lifetracker/app/MainActivity.kt`
- `app/src/main/java/com/lifetracker/app/LifeTrackerApplication.kt`
- `app/src/main/java/com/lifetracker/app/core/storage/StorageLocationManager.kt`
- `app/src/main/java/com/lifetracker/app/core/storage/StoragePlugin.kt`
- `app/src/main/java/com/lifetracker/app/core/storage/StoragePluginRegistry.kt`
- `app/src/main/java/com/lifetracker/app/core/storage/StoragePluginLogger.kt`
- `app/src/main/java/com/lifetracker/app/core/storage/AndroidStoragePluginLogger.kt`
- `app/src/main/java/com/lifetracker/app/plugins/storage/json/JsonlStorage.kt`
- `app/src/main/java/com/lifetracker/app/plugins/storage/json/JsonStoragePlugin.kt`
- `app/src/main/java/com/lifetracker/app/plugins/storage/sqlite/SqliteStorage.kt`
- `app/src/main/java/com/lifetracker/app/plugins/storage/sqlite/SqliteStoragePlugin.kt`
- `app/src/main/java/com/lifetracker/app/plugins/storage/sqlite/db/*`
- `app/src/main/java/com/lifetracker/app/plugins/storage/sqlite/sync/JsonlOutboxSyncWorker.kt`
- `app/src/main/java/com/lifetracker/app/di/AppContainer.kt`
- `app/src/main/java/com/lifetracker/app/ui/screens/StorageLocationSelectionScreen.kt`
- `app/build.gradle.kts`
- `gradle/libs.versions.toml`
- `docs/core_plugin_split_plan.md`
- `docs/plugin_dependency_overview.md`
- `docs/sqlite_jsonl_dual_run.md`
- `docs/testing_strategy.md`
- `docs/開発ガイド.md`
- `kernel/src/main/kotlin/com/lifetracker/core/analytics/EventAnalyticsRepository.kt`
- `docs/plugin_dependency_overview.md`

---

## 2025-02-07

### 自然言語タスク解析の拡張

#### 追加機能
- タイトル内の全角「！」から次のスペースまでをイベント文として抽出し、解析対象を明確化
- 抽出したイベント文から期限・通知を推定し、フォームのチップに「解析:」候補として提示
- 解析対象のイベント文をタイトル入力欄直下に表示し、ユーザーが自動補完内容を確認できるように改善
- クイック追加通知の「追加」アクションをインライン入力に切り替え、アプリへ遷移せずその場でタスク追加できるよう対応（必要な場合は「詳細」から従来フォームを開く）
- `？` で始まるリマインド文を解析し、期限より前/後や絶対時刻による通知設定に対応。設定値は `NaturalLanguageConfig` から変更可能に整理
- 分単位の指定（例: `？5分後`）を含むリマインダー解析に対応し、タスクカード上で次回通知時刻をチップ表示
- 新たに「設定」タブを追加し、イベント/リマインド用記号・デフォルト時刻に加えて辞書（相対日数マッピング）を階層化されたセクションから編集できるようにした

#### 技術的変更
- `NaturalLanguageParser` の出力にイベント文とクリーニング済みタイトルを追加
- `TaskCreationForm` で自動提案を受け取った際の優先順位（手動入力との整合）を制御するフラグを導入
- 送信時に解析済みタイトル・推定期限/通知を統合するよう送信ロジックを更新
- 相対日数マッピングを `NaturalLanguageConfig.ParserConfig` に統合し、設定マネージャーで永続化
- タスクカードでリマインダーをローカル時刻表示するための UI コンポーネントを追加

#### ファイル
- `app/src/main/java/com/lifetracker/app/util/NaturalLanguageParser.kt`
- `app/src/main/java/com/lifetracker/app/ui/components/TaskCreationForm.kt`
- `app/src/main/java/com/lifetracker/app/ui/components/TaskCard.kt`
- `app/src/main/java/com/lifetracker/app/ui/quickadd/TaskQuickAddNotifier.kt`
- `app/src/main/java/com/lifetracker/app/ui/quickadd/TaskQuickAddReceiver.kt`
- `app/src/main/AndroidManifest.xml`
- `app/src/main/java/com/lifetracker/app/util/NaturalLanguageConfig.kt`
- `app/src/main/java/com/lifetracker/app/settings/NaturalLanguageSettingsManager.kt`
- `app/src/main/java/com/lifetracker/app/ui/screens/SettingsScreen.kt`
- `app/src/main/java/com/lifetracker/app/viewmodel/SettingsViewModel.kt`
- `app/src/main/java/com/lifetracker/app/MainActivity.kt`
- `docs/specs/natural_language_config.md`

---

## 2025-02-06

### ホームダッシュボード実装

#### 追加機能
- `DashboardViewModel` を作成し、My Day/期限/完了/習慣の情報を集約
- `DashboardScreen` でカード形式の概要表示を実装
- タブナビゲーションに「ホーム」タブを追加
- ローディング/エラー状態のハンドリング

#### 技術的変更
- `lifecycle-runtime-compose` 依存関係を追加
  - `collectAsStateWithLifecycle()` を使用可能に
- 非推奨APIの更新
  - `Icons.Default.List` → `Icons.AutoMirrored.Filled.List`
  - `Divider` → `HorizontalDivider`
- `Dispatchers.IO` で初期化を実行し、起動パフォーマンスを改善

#### ファイル
- `app/src/main/java/com/lifetracker/app/viewmodel/DashboardViewModel.kt`
- `app/src/main/java/com/lifetracker/app/ui/screens/DashboardScreen.kt`
- `app/src/main/java/com/lifetracker/app/MainActivity.kt`
- `gradle/libs.versions.toml`
- `app/build.gradle.kts`

### チップ式タスク追加フォーム

#### 追加機能
- `TaskCreationForm` コンポーネントを新規作成
  - 属性・期限・通知・繰り返しをタップ時に展開
  - カスタム日時・ラベル入力に対応
- `TasksScreen` と `TaskQuickAddActivity` で共通利用

#### データモデル拡張
- `Task` に `repeatRule` と `repeatDetail` フィールドを追加
- カスタム繰り返し内容をテキストで保存可能に

#### 通知機能
- `LifeTrackerApplication` 起動時に常駐通知を表示
- 通知タップで `TaskQuickAddActivity` を起動
- アプリ非起動時でもタスク追加が可能

#### ファイル
- `app/src/main/java/com/lifetracker/app/ui/components/TaskCreationForm.kt`
- `app/src/main/java/com/lifetracker/app/data/model/Task.kt`
- `app/src/main/java/com/lifetracker/app/viewmodel/TasksViewModel.kt`
- `app/src/main/java/com/lifetracker/app/LifeTrackerApplication.kt`
- `app/src/main/java/com/lifetracker/app/ui/quickadd/TaskQuickAddActivity.kt`
- `app/src/main/java/com/lifetracker/app/ui/quickadd/TaskQuickAddNotifier.kt`

### ドキュメント追加
- `docs/todo_hub_dependencies.md` - 依存関係図
- `docs/todo_hub_feature_checklist.md` - 軽量実装プラン
- `docs/todo_update_20250206.md` - TODO機能アップデート概要
- `docs/update_20250206.md` - 更新ノート（英語）

---

## 2025-10-31

### v1.0.0 初回リリース

#### コア機能実装
- ✅ 習慣トラッキング基本機能
  - 習慣の作成・表示・完了記録
  - アイコンとカラーのカスタマイズ
  - デフォルト習慣（朝の運動、読書、瞑想）
- ✅ JSONLデータ永続化
  - イベントソーシングアーキテクチャ
  - ローカルファーストデータ保存
- ✅ MVVM アーキテクチャ
  - ViewModel層の実装
  - Repository パターン
  - 状態管理（Flow）

#### 技術スタック確定
- Kotlin 2.0.21
- Jetpack Compose
- Gradle 8.13.0
- Android API 26-34

#### ドキュメント作成
- 環境構築ガイド
- プロジェクトセットアップ
- データモデル設計
- コア機能実装
- 機能仕様書
- 実行計画

#### 動作確認
- ✅ 実機動作確認完了
- ✅ データ永続化確認
- ✅ UI動作確認

---

## 今後の予定

### Phase 1（継続中）
- クイックログ機能
- 統計・グラフ表示
- データエクスポート
- 通知リマインダー

### Phase 2（計画中）
- プラグインAPI
- E2EE同期サービス
- DevRelプログラム

### Phase 3（構想）
- Apple Health / Google Health Connect連携
- 自動相関発見エンジン
- iOS版（SwiftUI）

---

## バージョニングポリシー

- **メジャーバージョン** (1.x.x): 破壊的変更、大規模機能追加
- **マイナーバージョン** (x.1.x): 新機能追加、重要な改善
- **パッチバージョン** (x.x.1): バグ修正、小規模改善

---

**最新の更新内容は、このファイルの最上部を確認してください。**
- **2025-02-07**: タイトル内のイベント文を抽出して自然言語解析した結果をタスク作成フォームに自動反映。解析候補をチップとして提示しつつ、手動設定を優先できるようにした。
- **2025-02-06**: ホームダッシュボードとポモドーロタイマー連携を追加。タスク/習慣カードからタイマー起動が可能になり、`PomodoroCompleted` イベントを記録するようになった。プリセットに加えてカスタム時間入力ダイアログも追加。 通知権限リクエストを追加し、承認後にクイック追加通知を再表示するよう改善。 ポモドーロ時間設定をスライダー化し、通知からのインライン追加アクションを実装。
- **2025-02-06 (更新)**: ポモドーロ時間のプリセットを横スクロール対応に戻し、通知からのタスク追加をミニフォームで完結させるよう改善。通知タップでもアプリ本体を開かずに追加できる。
