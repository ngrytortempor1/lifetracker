# Analytics Graph View TODO

グラフビュー実装に向けて必要なタスクを整理したチェックリスト。ダッシュボードにイベント分析チャート（ローリング平均、タグリーダー、ルーチン予測散布図など）を追加することを目的とする。

---

## 設計思想
- **行動の「量」ではなく「質」を可視化する**: ヒートマップや件数グラフでは拾えなかった遷移パターンを抽出し、習慣の強弱や創造的フローの窓を見つけやすくする。
- **予測可能性プロットを軸に据える**: 横軸に完了時刻、縦軸に\(P(B\mid A)\) をとった散布図で、時間帯ごとのルーチンの自動化度合いを表現する。1時間バケットを基本としつつ、データ不足の区間は縮尺調整や欠損表示で誤読を防ぐ。
- **確率の信頼性を担保する**: 観測回数が少ないイベントは指数移動平均・ベイズ平滑化・最小サンプル閾値で安定化し、ユーザーに「推定保留」や「要観測」と明示する。
- **多指標のレイヤリングを控えめに**: 初期表示は完了率・未着手率・予測可能性の3軸に絞り、ユーザーが慣れてきたら時間帯／タグ別など追加の切り口を順次開放する。

---

## 1. 設計・要件定義
- [x] **UX 要件定義**: グラフ毎の洞察ポイントとテキストレポートの読み方を `docs/開発ガイド.md` に追記し、タスク完了／習慣／ログタグのペルソナ別ゴールを整理した。
- [x] **画面構成モック**: Compose 実装に合わせたカード配置・フィルター挙動を `docs/開発ガイド.md` のモック図に反映。
- [x] **データ密度・応答時間の目標**: 1,200 件を基準に 600ms 以内の取得を目標設定（`AnalyticsRepositoryPerformanceTest` 参照）。
- [x] **アクセシビリティ**: Chart/Leaderboard 共にセマンティクス記述を追加し、テキストレポートモードを実装。
- [x] 予測可能性プロットのプロット仕様を `AnalyticsGraphScreen` と `PredictabilityChart` に実装（サンプル不足、EMA 表示、凡例カルーセル）。

---

## 2. データパイプライン準備
- [x] `EventAnalyticsRepository` の API 拡張が必要か確認（例: 累積値、期間別バケットなど）。
- [x] ローカルキャッシュ戦略: `AnalyticsGraphViewModel` で LRU キャッシュと TTL を持つ `StateFlow` を実装。
- [x] SQLite/JSONL 双方で同じパフォーマンスを保証できるかベンチマーク。
- [x] 大量データのサンプルセットを作成（テストフィクスチャ）。
- [x] P(B|A) 推定用に「直前イベント」「現在イベント」「完了時刻」の履歴ストリームを抽出する。
- [x] 信頼度確保のためのスムージング手法（指数移動平均、ベイズ平滑化、最小観測数フィルタ）を実装し、閾値を検証する。
- [x] 時刻バケット（1h 基本、45/30 分への自動切替）のロジックを用意し、欠損バケットは UI へ「データ不足」として伝播するメタ情報を付与する。

---

## 3. UI 実装タスク
 - [x] 新しい `AnalyticsGraphScreen`（仮称）コンポーザブルを作成し、タブ／ナビゲーションから遷移できるようにする。
 - [x] Compose 用チャートライブラリを選定（`Canvas` ベースの独自描画方針に決定）。
 - [x] ローリング平均ラインチャート: 日付軸・タッチ時ツールチップ・範囲選択対応。
 - [x] クイックログタグの棒グラフ／ランキング表示。
 - [x] ルーチン遷移確率の散布図（`RoutinePredictabilityPoint` を可視化）。
 - [x] レスポンシブ対応（横画面／タブレット）を簡単にでも確認。
 - [x] 予測可能性プロットの点サイズ・色で頻度と直近変化を表現し、サンプル不足時はシンボル変更やツールチップで注意喚起する。
 - [x] 空バケット／データ不足区間をグレーアウトまたは補助ラインで表示し、誤解を防ぐ。
 - [x] バケットごとの詳細ダイアログを用意し、遷移ペア／サンプル数を確認できるようにする。

---

## 4. ViewModel / 状態管理
- [x] `AnalyticsGraphViewModel` を作成し、フィルター状態とグラフデータ取得をまとめる。
- [x] イベント種別フィルター・日付レンジの UI ↔ 状態バインディング（遷移分析はタスク専用のため期間・バケット切り替えで対応）。
- [x] ローディング／エラー状態とリトライのハンドリング。
- [x] テストダブル用の `EventAnalyticsRepository` 実装（モック）を追加し、UI テストで安定したデータを供給。
- [x] 予測可能性計算で使用するサンプル数や平滑化パラメータを状態として保持し、ユーザー設定やデフォルト値と同期させる。
- [x] 「推定保留」「観測不足」といったメッセージを UI に渡すためのステータス構造体を定義する。

---

## 5. テスト計画
- [x] ViewModel のユニットテスト（フィルター変更時のクエリ確認、空データ時のハンドリング）。
- [x] Compose UI のスナップショットテスト（主要グラフのセマンティクス出力）。
- [x] パフォーマンステスト: 1,000 件規模のイベントを読み込んでもスクロール／タブ切り替えが滑らかなことを確認。
- [x] アクセシビリティチェック: `Semantics` ラベル／コンテントディスクリプションが読み上げに適するか検証。

---

## 6. ドキュメント・リリース準備
- [x] `docs/更新履歴.md` にグラフビュー追加の概要を書く。
- [x] 操作手順や示唆の読み取り方を `docs/開発ガイド.md` またはユーザー向けドキュメントに追記。
- [x] 既存ダッシュボードからの遷移を `docs/戦略とビジョン.md` に反映し、分析基盤ロードマップを更新。
- [x] ベータテスト対象者（もし居れば）へのアナウンス文面を下書き。

---

## 7. リスクとフォールバック
- [x] ライブラリ依存が重い場合、既存のダッシュボードにミニグラフのみ追加するフォールバック案を用意。
- [x] 低スペック端末で描画が重い場合に備え、「テキストレポート表示」モードを検討。
- [x] ルーチン散布図の視覚的理解が難しい場合に備え、ツールチップやヘルプテキストの改善案をストック。

---

この TODO は実装フェーズ中も更新し、完了した項目にチェックを付けて進捗管理に利用してください。
